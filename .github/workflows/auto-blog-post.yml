name: Auto-Scaffold Blog Post

on:
  pull_request:
    types: [opened, reopened]
    branches:
      - main

jobs:
  scaffold-post:
    name: Scaffold Jekyll Post from Branch Name
    runs-on: ubuntu-latest

    # Only run when the PR branch starts with post/
    if: startsWith(github.head_ref, 'post/')

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract post slug from branch name
        id: slug
        run: |
          # Branch: post/my-ai-journey  â†’  slug: my-ai-journey
          BRANCH="${{ github.head_ref }}"
          SLUG="${BRANCH#post/}"
          DATE=$(date +%Y-%m-%d)
          FILENAME="_posts/${DATE}-${SLUG}.md"
          TITLE=$(echo "$SLUG" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')
          echo "slug=$SLUG"       >> $GITHUB_OUTPUT
          echo "date=$DATE"       >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "title=$TITLE"     >> $GITHUB_OUTPUT

      - name: Check if post file already exists
        id: check
        run: |
          if [ -f "${{ steps.slug.outputs.filename }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create scaffolded post file
        if: steps.check.outputs.exists == 'false'
        run: |
          mkdir -p _posts
          cat > "${{ steps.slug.outputs.filename }}" << 'EOF'
          ---
          layout: post
          title: "${{ steps.slug.outputs.title }}"
          date: ${{ steps.slug.outputs.date }}
          categories: []
          tags: []
          ---

          <!-- âœï¸ Write your post content below this line -->

          ## Introduction

          _Start writing here..._

          ## Main Content

          ## Conclusion
          EOF

      - name: Commit and push scaffolded post
        if: steps.check.outputs.exists == 'false'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ steps.slug.outputs.filename }}"
          git commit -m "chore: scaffold post '${{ steps.slug.outputs.title }}' [skip ci]"
          git push origin "${{ github.head_ref }}"

      - name: Comment on PR with next steps
        uses: actions/github-script@v7
        with:
          script: |
            const exists = "${{ steps.check.outputs.exists }}" === "true";
            const filename = "${{ steps.slug.outputs.filename }}";
            const title = "${{ steps.slug.outputs.title }}";

            const body = exists
              ? `### âš ï¸ Post file already exists\n\n\`${filename}\` was found in this branch â€” no scaffold was generated to avoid overwriting your work.`
              : `### ðŸ“ Blog post scaffolded!\n\n` +
                `A draft post has been created and committed to this branch:\n\n` +
                `\`\`\`\n${filename}\n\`\`\`\n\n` +
                `**Next steps:**\n` +
                `1. Pull the latest changes: \`git pull origin ${{ github.head_ref }}\`\n` +
                `2. Open \`${filename}\` and write your content\n` +
                `3. Push your changes and this PR will update automatically\n\n` +
                `> ðŸ¤– Auto-generated by the \`auto-blog-post\` workflow`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

  build-check:
    name: Verify Jekyll Build
    runs-on: ubuntu-latest
    needs: scaffold-post
    if: always() && startsWith(github.head_ref, 'post/')

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Build Jekyll site
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: Report build status
        if: success()
        run: echo "âœ… Jekyll build passed â€” safe to merge."
